--
-- PostgreSQL database dump
--

SET statement_timeout = 0;
SET lock_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SET check_function_bodies = false;
SET client_min_messages = warning;

--
-- Name: acs; Type: SCHEMA; Schema: -; Owner: postgres
--

CREATE SCHEMA acs;


ALTER SCHEMA acs OWNER TO postgres;

--
-- Name: plpgsql; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS plpgsql WITH SCHEMA pg_catalog;


--
-- Name: EXTENSION plpgsql; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';


--
-- Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA public;


--
-- Name: EXTENSION pgcrypto; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION pgcrypto IS 'cryptographic functions';


--
-- Name: uuid-ossp; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS "uuid-ossp" WITH SCHEMA public;


--
-- Name: EXTENSION "uuid-ossp"; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION "uuid-ossp" IS 'generate universally unique identifiers (UUIDs)';


SET search_path = public, pg_catalog;

--
-- Name: acs_auth(text, text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_auth(text, text) RETURNS text
    LANGUAGE plpgsql
    AS $_$
DECLARE
cnt int;
token text;
BEGIN
token = '';
SELECT COUNT(*) INTO cnt FROM acs.users WHERE id=$1 AND pass=crypt($2, pass);
IF cnt > 0 THEN
	token = uuid_generate_v4();
	INSERT INTO acs.tokens(user_id, token, exp_date) VALUES ($1, token, now() + interval '1' day);
	DELETE FROM acs.tokens WHERE user_id=$1 AND exp_date < now();
ELSE
	RAISE notice 'wrong';
END IF;

RETURN token;
END;
$_$;


ALTER FUNCTION public.acs_auth(text, text) OWNER TO postgres;

--
-- Name: acs_check_user(text, text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_check_user(text, text) RETURNS boolean
    LANGUAGE plpgsql
    AS $_$
DECLARE
cnt int;
BEGIN
SELECT COUNT(*) INTO cnt FROM acs.tokens WHERE user_id=$1 AND token=$2 AND exp_date >= now();
IF cnt > 0 THEN
	RETURN TRUE;
ELSE
	RETURN FALSE;
END IF;
END;
$_$;


ALTER FUNCTION public.acs_check_user(text, text) OWNER TO postgres;

--
-- Name: acs_get_user(text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_get_user(text) RETURNS text
    LANGUAGE plpgsql
    AS $_$
DECLARE
cnt int;
user_auth text;
BEGIN
user_auth = '';
SELECT user_id INTO user_auth FROM acs.tokens WHERE token=$1 AND exp_date >= now();

RETURN user_auth;
END;
$_$;


ALTER FUNCTION public.acs_get_user(text) OWNER TO postgres;

--
-- Name: acs_install(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_install() RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
cnt int;
BEGIN

SELECT COUNT(*) INTO cnt FROM information_schema.schemata WHERE schema_name = 'acs';
IF cnt = 0 THEN
	CREATE SCHEMA acs;
END IF;

--users
CREATE TABLE IF NOT EXISTS acs.users (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	id text NOT NULL,
	pass text NOT NULL,
	position_user text,
	realname text
);
--groups
CREATE TABLE IF NOT EXISTS acs.groups (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	group_id text NOT NULL,
	realname text
);
--group-user
CREATE TABLE IF NOT EXISTS acs.group_user (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	group_id uuid NOT NULL,
	user_id text NOT NULL
);
--group-struct
CREATE TABLE IF NOT EXISTS acs.groups_struct (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	group_id uuid NOT NULL,
	parent_id uuid,
	level integer
);
--record_rule
CREATE TABLE IF NOT EXISTS acs.record_rule (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	record_id uuid NOT NULL,
	rule_id uuid NOT NULL
);
--rules
CREATE TABLE IF NOT EXISTS acs.rules (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	rule_id uuid NOT NULL,
	rule_desc text
);
--rules-data
CREATE TABLE IF NOT EXISTS acs.rules_data (
	uuid_record uuid NOT NULL DEFAULT uuid_generate_v4(),
	rule_id uuid NOT NULL,
	rule_user text,
	rule_action text,
	rule_group text
);
--tokens
CREATE TABLE IF NOT EXISTS acs.tokens (
	user_id text NOT NULL,
	token text NOT NULL,
	exp_date timestamp
);
--changes_history
CREATE TABLE acs.changes_history
(
  change_uuid uuid NOT NULL DEFAULT uuid_generate_v4(),
  change_date timestamp without time zone NOT NULL,
  change_type text,
  change_db text,
  hash text
);
--changes_fields
CREATE TABLE acs.changes_fields
(
  db_name text NOT NULL,
  record_uuid uuid NOT NULL,
  change_uuid uuid NOT NULL,
  table_name text NOT NULL
);
--record_changes
CREATE TABLE acs.record_changes
(
  record_uuid uuid NOT NULL,
  time_modified timestamp without time zone NOT NULL,
  table_name text NOT NULL
);
--list tables
CREATE TABLE acs.vcs_tables
(
  table_name text NOT NULL,
  schema_name text NOT NULL
);

END;
$$;


ALTER FUNCTION public.acs_install() OWNER TO postgres;

--
-- Name: acs_protect_table(text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_protect_table(text) RETURNS void
    LANGUAGE plpgsql
    AS $_$
DECLARE
user_name text;
BEGIN

--EXECUTE 'ALTER TABLE '|| $1 ||' ADD COLUMN uuid_record uuid';
--EXECUTE 'ALTER TABLE '|| $1 ||' ALTER COLUMN uuid_record SET default uuid_generate_v4()';
--EXECUTE 'UPDATE '|| $1 ||' SET uuid_record=uuid_generate_v4()';
EXECUTE 'ALTER TABLE '|| $1 ||' RENAME TO ' || $1 || '_protected';
EXECUTE 'CREATE OR REPLACE VIEW  '|| $1 ||' AS SELECT * FROM ' || $1 || '_protected';

FOR user_name IN
	SELECT usename FROM pg_user
   LOOP
	EXECUTE 'GRANT ALL PRIVILEGES ON ' || $1 || ' TO ' || user_name;
	EXECUTE 'REVOKE ALL PRIVILEGES ON ' || $1 || '_protected FROM ' || user_name;
   END LOOP;

END;
$_$;


ALTER FUNCTION public.acs_protect_table(text) OWNER TO postgres;

--
-- Name: acs_table(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_table() RETURNS text
    LANGUAGE plpgsql
    AS $$
DECLARE
query_text text;
BEGIN

query_text = '(SELECT * FROM ttt)';

RETURN query_text;
END;
$$;


ALTER FUNCTION public.acs_table() OWNER TO postgres;

--
-- Name: acs_tg_audit(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_tg_audit() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
BEGIN

IF TG_OP = 'INSERT' THEN
	INSERT INTO acs.record_changes(record_uuid, time_modified, table_name) VALUES(NEW.uuid_record, now(), TG_RELNAME);
RETURN NULL;
ELSIF TG_OP = 'UPDATE' THEN
	UPDATE acs.record_changes SET time_modified=now() WHERE record_uuid=NEW.uuid_record;
RETURN NULL;
ELSIF TG_OP = 'DELETE' THEN
	DELETE FROM acs.record_changes WHERE record_uuid=OLD.uuid_record;
RETURN NULL;
END IF;

END;
$$;


ALTER FUNCTION public.acs_tg_audit() OWNER TO postgres;

--
-- Name: acs_vcs_compile(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_vcs_compile() RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
tname text;
ruuid text;
cdate timestamp;
BEGIN

SELECT change_date INTO cdate FROM acs.changes_history ORDER BY change_date DESC LIMIT 1;
--RAISE notice 'date %', cdate;
IF cdate IS NULL THEN
	RETURN;
END IF;

FOR tname IN SELECT table_name FROM acs.vcs_tables
   LOOP
	--RAISE notice 'table %', tname;
	FOR ruuid IN EXECUTE 'SELECT '|| tname ||'.uuid_record FROM '|| tname ||' LEFT OUTER JOIN acs.record_changes ON ('|| tname ||'.uuid_record = acs.record_changes.record_uuid) WHERE acs.record_changes.time_modified >= '|| quote_literal(cdate)
	LOOP
		--RAISE notice 'uuid record %', ruuid;
		EXECUTE 'INSERT INTO acs.changes_fields(db_name,record_uuid,change_uuid,table_name) VALUES(current_database(), '|| quote_literal(ruuid) ||', uuid_generate_v4(), '|| quote_literal(tname) ||')';
	END LOOP;
   END LOOP;

END;
$$;


ALTER FUNCTION public.acs_vcs_compile() OWNER TO postgres;

--
-- Name: acs_vcs_compile(text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_vcs_compile(text) RETURNS void
    LANGUAGE plpgsql
    AS $_$
DECLARE
tname text;
ruuid text;
uuid_change uuid;
cdate timestamp;
BEGIN

SELECT change_date INTO cdate FROM acs.changes_history ORDER BY change_date DESC LIMIT 1;
--RAISE notice 'date %', cdate;
IF cdate IS NULL THEN
	RETURN;
END IF;

uuid_change = uuid_generate_v4();

FOR tname IN SELECT table_name FROM acs.vcs_tables
   LOOP
	--RAISE notice 'table %', tname;
	FOR ruuid IN EXECUTE 'SELECT '|| tname ||'.uuid_record FROM '|| tname ||' LEFT OUTER JOIN acs.record_changes ON ('|| tname ||'.uuid_record = acs.record_changes.record_uuid) WHERE acs.record_changes.time_modified >= '|| quote_literal(cdate)
	LOOP
		--RAISE notice 'uuid record %', ruuid;
		EXECUTE 'INSERT INTO acs.changes_fields(db_name,record_uuid,change_uuid,table_name) VALUES(current_database(), '|| quote_literal(ruuid) ||', '|| quote_literal(uuid_change) ||', '|| quote_literal(tname) ||')';
	END LOOP;
   END LOOP;

INSERT INTO acs.changes_history(change_uuid, change_date, change_type, change_db, hash) VALUES (uuid_change, now(), 'compile', current_database(), $1);

END;
$_$;


ALTER FUNCTION public.acs_vcs_compile(text) OWNER TO postgres;

--
-- Name: acs_vcs_init(); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_vcs_init() RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
tname text;
BEGIN

FOR tname IN
	SELECT quote_ident(table_name)
	FROM   information_schema.tables
	WHERE  table_schema = 'public' AND table_type = 'BASE TABLE'
   LOOP
	EXECUTE 'SELECT acs_vcs_table_add('|| quote_literal(tname) ||')';
   END LOOP;

INSERT INTO acs.changes_history(change_uuid, change_date, change_type, change_db) VALUES (uuid_generate_v4(), now(), 'init', current_database());

END;
$$;


ALTER FUNCTION public.acs_vcs_init() OWNER TO postgres;

--
-- Name: acs_vcs_table_add(text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_vcs_table_add(text) RETURNS void
    LANGUAGE plpgsql
    AS $_$
DECLARE
ruuid text;
BEGIN

EXECUTE 'ALTER TABLE '|| $1 ||' ADD COLUMN uuid_record uuid';
EXECUTE 'ALTER TABLE '|| $1 ||' ALTER COLUMN uuid_record SET default uuid_generate_v4()';
EXECUTE 'UPDATE '|| $1 ||' SET uuid_record=uuid_generate_v4()';

FOR ruuid IN EXECUTE 'SELECT uuid_record FROM ' || $1
	LOOP
		EXECUTE 'INSERT INTO acs.record_changes(record_uuid, time_modified, table_name) VALUES('||quote_literal(ruuid)||', now(), '||quote_literal($1)||')';
	END LOOP;

EXECUTE 'CREATE TRIGGER t_acs_'|| $1 ||'
AFTER INSERT OR UPDATE OR DELETE ON '|| $1 ||' FOR EACH ROW
EXECUTE PROCEDURE acs_tg_audit()';

EXECUTE 'INSERT INTO acs.vcs_tables(table_name, schema_name) VALUES('|| quote_literal($1) ||', '|| quote_literal('public') ||')';

END;
$_$;


ALTER FUNCTION public.acs_vcs_table_add(text) OWNER TO postgres;

--
-- Name: acs_vcs_table_rm(text); Type: FUNCTION; Schema: public; Owner: postgres
--

CREATE FUNCTION acs_vcs_table_rm(text) RETURNS void
    LANGUAGE plpgsql
    AS $_$
DECLARE
BEGIN

EXECUTE 'ALTER TABLE '|| $1 ||' DROP COLUMN IF EXISTS uuid_record';
EXECUTE 'DELETE FROM acs.record_changes WHERE table_name='|| quote_literal($1);
EXECUTE 'DELETE FROM acs.vcs_tables WHERE table_name='|| quote_literal($1);
EXECUTE 'DROP TRIGGER IF EXISTS t_acs_'|| $1 ||' ON ' || $1;

END;
$_$;


ALTER FUNCTION public.acs_vcs_table_rm(text) OWNER TO postgres;

SET search_path = acs, pg_catalog;

SET default_tablespace = '';

SET default_with_oids = false;

--
-- Name: changes_fields; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE changes_fields (
    db_name text NOT NULL,
    record_uuid uuid NOT NULL,
    change_uuid uuid NOT NULL,
    table_name text NOT NULL
);


ALTER TABLE acs.changes_fields OWNER TO postgres;

--
-- Name: changes_history; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE changes_history (
    change_uuid uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    change_date timestamp without time zone NOT NULL,
    change_type text,
    change_db text,
    hash text
);


ALTER TABLE acs.changes_history OWNER TO postgres;

--
-- Name: group_user; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE group_user (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    group_id uuid NOT NULL,
    user_id text NOT NULL
);


ALTER TABLE acs.group_user OWNER TO postgres;

--
-- Name: groups; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE groups (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    group_id text NOT NULL,
    realname text
);


ALTER TABLE acs.groups OWNER TO postgres;

--
-- Name: groups_struct; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE groups_struct (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    group_id uuid NOT NULL,
    parent_id uuid,
    level integer
);


ALTER TABLE acs.groups_struct OWNER TO postgres;

--
-- Name: record_changes; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE record_changes (
    record_uuid uuid NOT NULL,
    time_modified timestamp without time zone NOT NULL,
    table_name text NOT NULL
);


ALTER TABLE acs.record_changes OWNER TO postgres;

--
-- Name: record_rule; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE record_rule (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    record_id uuid NOT NULL,
    rule_id uuid NOT NULL
);


ALTER TABLE acs.record_rule OWNER TO postgres;

--
-- Name: rules; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE rules (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    rule_id uuid NOT NULL,
    rule_desc text
);


ALTER TABLE acs.rules OWNER TO postgres;

--
-- Name: rules_data; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE rules_data (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    rule_id uuid NOT NULL,
    rule_user text,
    rule_action text,
    rule_group text
);


ALTER TABLE acs.rules_data OWNER TO postgres;

--
-- Name: tokens; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE tokens (
    user_id text NOT NULL,
    token text NOT NULL,
    exp_date timestamp without time zone
);


ALTER TABLE acs.tokens OWNER TO postgres;

--
-- Name: users; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE users (
    uuid_record uuid DEFAULT public.uuid_generate_v4() NOT NULL,
    id text NOT NULL,
    pass text NOT NULL,
    position_user text,
    realname text
);


ALTER TABLE acs.users OWNER TO postgres;

--
-- Name: vcs_tables; Type: TABLE; Schema: acs; Owner: postgres; Tablespace: 
--

CREATE TABLE vcs_tables (
    table_name text NOT NULL,
    schema_name text NOT NULL
);


ALTER TABLE acs.vcs_tables OWNER TO postgres;

SET search_path = public, pg_catalog;

--
-- Name: fruits; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE fruits (
    name name,
    cnt integer,
    uuid_record uuid DEFAULT uuid_generate_v4()
);


ALTER TABLE public.fruits OWNER TO postgres;

--
-- Name: test_protected; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE test_protected (
    id text,
    name_p text,
    property text,
    price double precision,
    rule uuid,
    uuid_record uuid DEFAULT uuid_generate_v4()
);


ALTER TABLE public.test_protected OWNER TO postgres;

--
-- Name: test; Type: VIEW; Schema: public; Owner: postgres
--

CREATE VIEW test AS
 SELECT test_protected.id,
    test_protected.name_p,
    test_protected.property,
    test_protected.price,
    test_protected.rule
   FROM test_protected;


ALTER TABLE public.test OWNER TO postgres;

--
-- Name: ttt; Type: TABLE; Schema: public; Owner: postgres; Tablespace: 
--

CREATE TABLE ttt (
    val integer,
    uuid_record uuid DEFAULT uuid_generate_v4()
);


ALTER TABLE public.ttt OWNER TO postgres;

SET search_path = acs, pg_catalog;

--
-- Data for Name: changes_fields; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY changes_fields (db_name, record_uuid, change_uuid, table_name) FROM stdin;
infosystem	a9b28367-12f0-434d-a707-83d882cf6eea	4ec54616-8772-47bd-9b24-b6cc188612ce	ttt
infosystem	105393f5-d2ae-470a-b105-952cf2a9c4d3	4ec54616-8772-47bd-9b24-b6cc188612ce	ttt
infosystem	ceeb232b-ec3b-4f2e-b8ca-85df84e4b745	4ec54616-8772-47bd-9b24-b6cc188612ce	ttt
infosystem	883201e4-2a2d-4dce-b2e0-b8c01ed500e7	4ec54616-8772-47bd-9b24-b6cc188612ce	ttt
infosystem	4bf2e17e-af3b-4ada-b7a4-00720d39f3fa	4ec54616-8772-47bd-9b24-b6cc188612ce	fruits
infosystem	d613a196-7dcf-47fb-beb6-be2cd63f0343	4ec54616-8772-47bd-9b24-b6cc188612ce	fruits
infosystem	fc8896aa-6882-4164-a68f-9810f48d5822	4ec54616-8772-47bd-9b24-b6cc188612ce	fruits
infosystem	498e3284-ec42-4501-b286-4263a9ab56e7	4ec54616-8772-47bd-9b24-b6cc188612ce	fruits
infosystem	000e1923-e39b-46d2-aaa0-46be532d2ab4	4ec54616-8772-47bd-9b24-b6cc188612ce	test_protected
infosystem	efde8bae-4850-4b81-8f44-eaa033855ca5	4ec54616-8772-47bd-9b24-b6cc188612ce	test_protected
infosystem	815d89f5-d5cb-4ac4-abec-9d41ad953e83	4ec54616-8772-47bd-9b24-b6cc188612ce	test_protected
infosystem	849c6c5c-2789-4fa4-9f21-8332135bd309	4ec54616-8772-47bd-9b24-b6cc188612ce	test_protected
infosystem	d314824c-1b31-4e99-93bc-6ba4f78d20bf	4ec54616-8772-47bd-9b24-b6cc188612ce	test_protected
infosystem	54a4af65-c075-4ba4-9187-6fc273dd74a3	1b36a7aa-266c-43c8-913f-afbf0d055c42	ttt
\.


--
-- Data for Name: changes_history; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY changes_history (change_uuid, change_date, change_type, change_db, hash) FROM stdin;
eb222186-3022-4a49-9348-bf05fe5681e8	2016-03-23 12:15:10.052015	init	infosystem	\N
4ec54616-8772-47bd-9b24-b6cc188612ce	2016-03-23 12:16:12.814066	compile	infosystem	c24943720edefb9cf8142543bf385a15
1b36a7aa-266c-43c8-913f-afbf0d055c42	2016-03-23 12:18:37.224516	compile	infosystem	ca2c243300ff23976d703bd076102830
ed979b10-1aea-4aa1-be54-72c6e7c72900	2016-03-23 12:23:21.985039	compile	infosystem	ca2c243300ff23976d703bd076102830
\.


--
-- Data for Name: group_user; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY group_user (uuid_record, group_id, user_id) FROM stdin;
\.


--
-- Data for Name: groups; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY groups (uuid_record, group_id, realname) FROM stdin;
dca203c9-f968-407f-8bd7-353b2e25a91e	bf9e361f-16ab-485a-48bf-d2c7379c20dd	Группа 1
\.


--
-- Data for Name: groups_struct; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY groups_struct (uuid_record, group_id, parent_id, level) FROM stdin;
\.


--
-- Data for Name: record_changes; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY record_changes (record_uuid, time_modified, table_name) FROM stdin;
a9b28367-12f0-434d-a707-83d882cf6eea	2016-03-23 12:15:10.052015	ttt
105393f5-d2ae-470a-b105-952cf2a9c4d3	2016-03-23 12:15:10.052015	ttt
ceeb232b-ec3b-4f2e-b8ca-85df84e4b745	2016-03-23 12:15:10.052015	ttt
883201e4-2a2d-4dce-b2e0-b8c01ed500e7	2016-03-23 12:15:10.052015	ttt
4bf2e17e-af3b-4ada-b7a4-00720d39f3fa	2016-03-23 12:15:10.052015	fruits
d613a196-7dcf-47fb-beb6-be2cd63f0343	2016-03-23 12:15:10.052015	fruits
fc8896aa-6882-4164-a68f-9810f48d5822	2016-03-23 12:15:10.052015	fruits
498e3284-ec42-4501-b286-4263a9ab56e7	2016-03-23 12:15:10.052015	fruits
000e1923-e39b-46d2-aaa0-46be532d2ab4	2016-03-23 12:15:10.052015	test_protected
efde8bae-4850-4b81-8f44-eaa033855ca5	2016-03-23 12:15:10.052015	test_protected
815d89f5-d5cb-4ac4-abec-9d41ad953e83	2016-03-23 12:15:10.052015	test_protected
849c6c5c-2789-4fa4-9f21-8332135bd309	2016-03-23 12:15:10.052015	test_protected
d314824c-1b31-4e99-93bc-6ba4f78d20bf	2016-03-23 12:15:10.052015	test_protected
54a4af65-c075-4ba4-9187-6fc273dd74a3	2016-03-23 12:18:34.014845	ttt
\.


--
-- Data for Name: record_rule; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY record_rule (uuid_record, record_id, rule_id) FROM stdin;
\.


--
-- Data for Name: rules; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY rules (uuid_record, rule_id, rule_desc) FROM stdin;
\.


--
-- Data for Name: rules_data; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY rules_data (uuid_record, rule_id, rule_user, rule_action, rule_group) FROM stdin;
\.


--
-- Data for Name: tokens; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY tokens (user_id, token, exp_date) FROM stdin;
admin	474ca043-2bc4-4758-8137-77c92fbcb921	2016-03-23 16:57:55.103933
\.


--
-- Data for Name: users; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY users (uuid_record, id, pass, position_user, realname) FROM stdin;
8c7bc8ac-5460-4317-8a48-53fa9d7c2ee0	admin	$2a$06$ExFpgCAbAo/WPQPj3cCW8.K0LIxGXgeAcws44rY8Tur8taMzSP7bK		Администратор
48780d19-a97e-472a-9007-97a2b72aab13	dima	$2a$06$XkOiyy/RBRRqJraVBdRD0uSWf.WqKLnZWTq7q5F.f2JJ8Jcvf.03C		Дмитрий
\.


--
-- Data for Name: vcs_tables; Type: TABLE DATA; Schema: acs; Owner: postgres
--

COPY vcs_tables (table_name, schema_name) FROM stdin;
ttt	public
fruits	public
test_protected	public
\.


SET search_path = public, pg_catalog;

--
-- Data for Name: fruits; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY fruits (name, cnt, uuid_record) FROM stdin;
23231	3	4bf2e17e-af3b-4ada-b7a4-00720d39f3fa
23231	3	d613a196-7dcf-47fb-beb6-be2cd63f0343
23231	3	fc8896aa-6882-4164-a68f-9810f48d5822
23231	3	498e3284-ec42-4501-b286-4263a9ab56e7
\.


--
-- Data for Name: test_protected; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY test_protected (id, name_p, property, price, rule, uuid_record) FROM stdin;
1	name1	s	120	\N	000e1923-e39b-46d2-aaa0-46be532d2ab4
5	name5	v	124	\N	efde8bae-4850-4b81-8f44-eaa033855ca5
2	name2	s	150	\N	815d89f5-d5cb-4ac4-abec-9d41ad953e83
4	name4	z	120	\N	849c6c5c-2789-4fa4-9f21-8332135bd309
3	name3	q	150	937dd1f3-70ea-479e-7b87-4afd1b380f06	d314824c-1b31-4e99-93bc-6ba4f78d20bf
\.


--
-- Data for Name: ttt; Type: TABLE DATA; Schema: public; Owner: postgres
--

COPY ttt (val, uuid_record) FROM stdin;
100	a9b28367-12f0-434d-a707-83d882cf6eea
1	105393f5-d2ae-470a-b105-952cf2a9c4d3
220	ceeb232b-ec3b-4f2e-b8ca-85df84e4b745
128	883201e4-2a2d-4dce-b2e0-b8c01ed500e7
135	54a4af65-c075-4ba4-9187-6fc273dd74a3
\.


--
-- Name: t_acs_fruits; Type: TRIGGER; Schema: public; Owner: postgres
--

CREATE TRIGGER t_acs_fruits AFTER INSERT OR DELETE OR UPDATE ON fruits FOR EACH ROW EXECUTE PROCEDURE acs_tg_audit();


--
-- Name: t_acs_test_protected; Type: TRIGGER; Schema: public; Owner: postgres
--

CREATE TRIGGER t_acs_test_protected AFTER INSERT OR DELETE OR UPDATE ON test_protected FOR EACH ROW EXECUTE PROCEDURE acs_tg_audit();


--
-- Name: t_acs_ttt; Type: TRIGGER; Schema: public; Owner: postgres
--

CREATE TRIGGER t_acs_ttt AFTER INSERT OR DELETE OR UPDATE ON ttt FOR EACH ROW EXECUTE PROCEDURE acs_tg_audit();


--
-- Name: public; Type: ACL; Schema: -; Owner: postgres
--

REVOKE ALL ON SCHEMA public FROM PUBLIC;
REVOKE ALL ON SCHEMA public FROM postgres;
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO PUBLIC;


--
-- Name: test_protected; Type: ACL; Schema: public; Owner: postgres
--

REVOKE ALL ON TABLE test_protected FROM PUBLIC;
REVOKE ALL ON TABLE test_protected FROM postgres;


--
-- Name: test; Type: ACL; Schema: public; Owner: postgres
--

REVOKE ALL ON TABLE test FROM PUBLIC;
REVOKE ALL ON TABLE test FROM postgres;
GRANT ALL ON TABLE test TO postgres;
GRANT ALL ON TABLE test TO admin;
GRANT ALL ON TABLE test TO dima;


--
-- PostgreSQL database dump complete
--

